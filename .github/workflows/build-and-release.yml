name: Build and Release Multi-Platform

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Build C program
      run: |
        gcc testing.c -o testing.exe
        echo "Build completed successfully"
        dir testing.exe

    - name: Create release directory
      run: |
        mkdir -p release

    - name: Copy binary to release directory
      run: |
        copy testing.exe release\

    - name: Create release notes
      run: |
        echo "# Release ${{ github.ref_name }}" > release\RELEASE_NOTES.md
        echo "## Build Information" >> release\RELEASE_NOTES.md
        echo "- OS: Windows" >> release\RELEASE_NOTES.md
        echo "- Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> release\RELEASE_NOTES.md
        echo "- Commit: ${{ github.sha }}" >> release\RELEASE_NOTES.md
        echo "## Changes" >> release\RELEASE_NOTES.md
        echo "- Automated build from commit ${{ github.sha }}" >> release\RELEASE_NOTES.md

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-binary
        path: |
          release/
        retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Build C program
      run: |
        gcc testing.c -o testing
        echo "Build completed successfully"
        ls -la testing

    - name: Create release directory
      run: |
        mkdir -p release

    - name: Copy binary to release directory
      run: |
        cp testing release/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-binary
        path: |
          release/
        retention-days: 30

  create-release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    permissions:
        contents: write
        packages: write
        actions: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: windows-binary
        path: artifacts/windows/

    - name: Download Linux artifact
      uses: actions/download-artifact@v4
      with:
        name: linux-binary
        path: artifacts/linux/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          ## Release ${{ github.ref_name }}
          
          This is an automated release created by GitHub Actions.
          
          ### Build Information
          - **Tag**: ${{ github.ref_name }}
          - **Commit**: ${{ github.sha }}
          - **Date**: ${{ github.event.head_commit.timestamp }}
          - **Platforms**: Windows, Linux (Ubuntu)
          
          ### Available Binaries
          - **Windows**: `testing.exe` (executable for Windows)
          - **Linux**: `testing` (executable for Linux/Ubuntu)
          
          ### Build Process
          The C program was compiled using GCC on both Windows and Linux platforms.
          
          ### Usage
          **Windows:**
          ```bash
          testing.exe
          ```
          
          **Linux/Ubuntu:**
          ```bash
          chmod +x testing
          ./testing
          ```
          
          ### Source Code
          Commit: `${{ github.sha }}`
          
          ### Release Notes
          Automated build from commit ${{ github.sha }}.
          
        files: |
          artifacts/windows/testing.exe
          artifacts/windows/RELEASE_NOTES.md
          artifacts/linux/testing
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}