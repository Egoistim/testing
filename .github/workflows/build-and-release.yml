name: Build and Release Windows

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Build C program
      run: |
        gcc testing.c -o testing.exe
        echo "Build completed successfully"
        dir testing.exe

    - name: Create release directory
      run: |
        mkdir -p release

    - name: Copy binary to release directory
      run: |
        copy testing.exe release\

    - name: Create release notes
      run: |
        echo "# Release ${{ github.ref_name }}" > release\RELEASE_NOTES.md
        echo "## Build Information" >> release\RELEASE_NOTES.md
        echo "- OS: Windows" >> release\RELEASE_NOTES.md
        echo "- Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> release\RELEASE_NOTES.md
        echo "- Commit: ${{ github.sha }}" >> release\RELEASE_NOTES.md
        echo "## Changes" >> release\RELEASE_NOTES.md
        echo "- Automated build from commit ${{ github.sha }}" >> release\RELEASE_NOTES.md

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-binary
        path: |
          release/
        retention-days: 30

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    permissions:
        contents: write
        packages: write
        actions: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: windows-binary
        path: artifacts/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          ## Release ${{ github.ref_name }}
          
          This is an automated release created by GitHub Actions.
          
          ### Build Information
          - **Tag**: ${{ github.ref_name }}
          - **Commit**: ${{ github.sha }}
          - **Date**: ${{ github.event.head_commit.timestamp }}
          - **Platform**: Windows
          
          ### Available Binary
          - **Windows**: `testing.exe`
          
          ### Build Process
          The C program was compiled using GCC on Windows.
          
          ### Usage
          ```bash
          testing.exe
          ```
          
          ### Source Code
          Commit: `${{ github.sha }}`
          
          ### Release Notes
          Automated build from commit ${{ github.sha }}.
          
        files: |
          artifacts/testing.exe
          artifacts/RELEASE_NOTES.md
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}